import requests
from bs4 import BeautifulSoup
import urllib.parse

class VulnScanner:
    def __init__(self, url):
        self.url = url

    def get_forms(self):
        try:
            response = requests.get(self.url, timeout=10)
            soup = BeautifulSoup(response.content, 'html.parser')
            return soup.find_all('form')
        except Exception as e:
            print(f"Error fetching forms: {e}")
            return []

    def submit_form(self, form, payload):
        action = form.get('action')
        method = form.get('method', 'get').lower()
        inputs = form.find_all('input')
        data = {input_tag.get('name'): payload for input_tag in inputs if input_tag.get('name')}

        action_url = urllib.parse.urljoin(self.url, action) if action else self.url
        try:
            if method == 'post':
                response = requests.post(action_url, data=data, timeout=10)
            else:
                response = requests.get(action_url, params=data, timeout=10)
            return response
        except Exception as e:
            print(f"Error submitting form: {e}")
            return None

    def test_sqli(self, form):
        payloads = ["' OR 1=1 --", "' OR '1'='1"]
        for payload in payloads:
            response = self.submit_form(form, payload)
            if response and ('error' in response.text.lower() or 'sql' in response.text.lower()):
                return True
        return False

    def test_xss(self, form):
        payloads = ["<script>alert('XSS')</script>", "<img src=x onerror=alert('XSS')>"]
        for payload in payloads:
            response = self.submit_form(form, payload)
            if response and payload in response.text:
                return True
        return False

    def scan(self):
        print(f"Scanning {self.url} for vulnerabilities...")
        forms = self.get_forms()
        if not forms:
            print("No forms found.")
            return

        for i, form in enumerate(forms):
            print(f"\nTesting form {i+1}: {form.get('action', 'No action')}")
            if self.test_sqli(form):
                print("  [VULNERABILITY] Potential SQL Injection detected!")
            else:
                print("  No SQL Injection detected.")
            if self.test_xss(form):
                print("  [VULNERABILITY] Potential XSS detected!")
            else:
                print("  No XSS detected.")